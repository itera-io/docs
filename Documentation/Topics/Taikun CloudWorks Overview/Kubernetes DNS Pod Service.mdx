# Kubernetes DNS Pod Service

# DNS for Services and Pods

Kubernetes creates DNS records for Services and Pods. You can contact Services with consistent DNS names instead of IP addresses.

Kubernetes publishes information about Pods and Services which is used to program DNS. Kubelet configures Podsâ€™ DNS so that running containers can lookup Services by name rather than IP.

Services defined in the cluster are assigned DNS names. By default, a client Podâ€™s DNS search list includes the Podâ€™s own namespace and the clusterâ€™s default domain.

### Namespaces of Services

A DNS query may return different results based on the namespace of the Pod making it. DNS queries that donâ€™t specify a namespace are limited to the Podâ€™s namespace. Access Services in other namespaces by specifying it in the DNS query.

For example, consider a Pod in aÂ `test`Â namespace. AÂ `data`Â Service is in theÂ `prod`Â namespace.

A query forÂ `data`Â returns no results, because it uses the Podâ€™sÂ `test`Â namespace.

A query forÂ `data.prod`Â returns the intended result, because it specifies the namespace.

DNS queries may be expanded using the Podâ€™sÂ `/etc/resolv.conf`. Kubelet configures this file for each Pod. For example, a query for justÂ `data`Â may be expanded toÂ `data.test.svc.cluster.local`. The values of theÂ `search`Â option are used to expand queries. To learn more about DNS queries, seeÂ [theÂ `resolv.conf`Â manual page.](https://www.man7.org/linux/man-pages/man5/resolv.conf.5.html)

`nameserver 10.32.0.10`
`search <namespace>.svc.cluster.local svc.cluster.local cluster.local`
`options ndots:5`

In summary, a Pod in theÂ *test*Â namespace can successfully resolve eitherÂ `data.prod`Â orÂ `data.prod.svc.cluster.local`.

### DNS Records

What objects get DNS records?

1. Services

2. Pods

The following sections detail the supported DNS record types and layout that is supported. Any other layout or names or queries that happen to work are considered implementation details and are subject to change without warning. For more up-to-date specifications, seeÂ [Kubernetes DNS-Based Service Discovery](https://github.com/kubernetes/dns/blob/master/docs/specification.md).

## Services

### A/AAAA records

â€œNormalâ€ (not headless) Services are assigned DNS A and/or AAAA records, depending on the IP family or families of the Service, with a name of the formÂ `my-svc.my-namespace.svc.cluster-domain.example`. This resolves to the cluster IP of the Service.

[Headless Services](https://kubernetes.io/docs/concepts/services-networking/service/#headless-services)Â (without a cluster IP) Services are also assigned DNS A and/or AAAA records, with a name of the formÂ `my-svc.my-namespace.svc.cluster-domain.example`. Unlike normal Services, this resolves to the set of IPs of all of the Pods selected by the Service. Clients are expected to consume the set or else use standard round-robin selection from the set.

### SRV records

SRV Records are created for named ports that are part of normal or headless services. For each named port, the SRV record has the formÂ `_port-name._port-protocol.my-svc.my-namespace.svc.cluster-domain.example`. For a regular Service, this resolves to the port number and the domain name:Â `my-svc.my-namespace.svc.cluster-domain.example`. For a headless Service, this resolves to multiple answers, one for each Pod that is backing the Service, and contains the port number and the domain name of the Pod of the formÂ `hostname.my-svc.my-namespace.svc.cluster-domain.example`.

## Pods

### A/AAAA records

Kube-DNS versions, before the implementation of theÂ [DNS specification](https://github.com/kubernetes/dns/blob/master/docs/specification.md), had the following DNS resolution:

`pod-ipv4-address.my-namespace.pod.cluster-domain.example.`

For example, if a Pod in theÂ `default`Â namespace has the IP address 172.17.0.3, and the domain name for your cluster isÂ `cluster.local`, then the Pod has a DNS name:

`172-17-0-3.default.pod.cluster.local.`

Any Pods exposed by a Service have the following DNS resolution available:

`pod-ipv4-address.service-name.my-namespace.svc.cluster-domain.example.`

### Podâ€™s hostname and subdomain fields

Currently, when a Pod is created, its hostname (as observed from within the Pod) is the Podâ€™sÂ `metadata.name`Â value.

The Pod spec has an optionalÂ `hostname`Â field, which can be used to specify a different hostname. When specified, it takes precedence over the Podâ€™s name to be the hostname of the Pod (again, as observed from within the Pod). For example, given a Pod withÂ `spec.hostname`Â set toÂ `"my-host"`, the Pod will have its hostname set toÂ `"my-host"`.

The Pod spec also has an optionalÂ `subdomain`Â field, which can be used to indicate that the pod is part of a sub-group of the namespace. For example, a Pod withÂ `spec.hostname`Â set toÂ `"foo"`, andÂ `spec.subdomain`Â set toÂ `"bar"`, in namespaceÂ `"my-namespace"`, will have its hostname set toÂ `"foo"`Â and its fully qualified domain name (FQDN) set toÂ `"foo.bar.my-namespace.svc.cluster.local"`Â (once more, as observed from within the Pod).

If a headless Service exists in the same namespace as the Pod, with the same name as the subdomain, the clusterâ€™s DNS Server also returns A and/or AAAA records for the Podâ€™s fully qualified hostname.

Example:

`apiVersion: v1`
`kind: Service`
`metadata:`
`  name: busybox-subdomain`
`spec:`
`  selector:`
`    name: busybox`
`  clusterIP: None`
`  ports:`
`  - name: foo # name is not required for single-port Services`
`    port: 1234`
`---`
`apiVersion: v1`
`kind: Pod`
`metadata:`
`  name: busybox1`
`  labels:`
`    name: busybox`
`spec:`
`  hostname: busybox-1`
`  subdomain: busybox-subdomain`
`  containers:`
`  - image: busybox:1.28`
`    command:`
`      - sleep`
`      - "3600"`
`    name: busybox`
`---`
`apiVersion: v1`
`kind: Pod`
`metadata:`
`  name: busybox2`
`  labels:`
`    name: busybox`
`spec:`
`  hostname: busybox-2`
`  subdomain: busybox-subdomain`
`  containers:`
`  - image: busybox:1.28`
`    command:`
`      - sleep`
`      - "3600"`
`    name: busybox`

Given the above ServiceÂ `"busybox-subdomain"`Â and the Pods, which setÂ `spec.subdomain`Â toÂ `"busybox-subdomain"`, the first Pod will see its own FQDN asÂ `"busybox-1.busybox-subdomain.my-namespace.svc.cluster-domain.example"`. DNS serves A and/or AAAA records at that name, pointing to the Podâ€™s IP. Both Pods â€œ`busybox1`â€ And â€œ`busybox2`â€ will have their own address records.

AnÂ [EndpointSlice](https://kubernetes.io/docs/concepts/services-networking/endpoint-slices/)Â can specify the DNS hostname for any endpoint address, along with its IP.

**Note:**Â Because A and AAAA records are not created for Pod names,Â `hostname`Â is required for the Podâ€™s A or AAAA record to be created. A Pod with noÂ `hostname`Â but withÂ `subdomain`Â will only create the A or AAAA record for the headless Service (`busybox-subdomain.my-namespace.svc.cluster-domain.example`), pointing to the Podsâ€™ IP addresses. Also, the Pod needs to be ready in order to have a record unlessÂ `publishNotReadyAddresses=True`Â is set on the Service.

### Podâ€™s setHostnameAsFQDN field

**FEATURE STATE:**Â `Kubernetes v1.22 [stable]`

When a Pod is configured to have a fully qualified domain name (FQDN), its hostname is the short hostname. For example, if you have a Pod with a fully qualified domain nameÂ busybox-1.busybox-subdomain.my-namespace.svc.cluster-domain.example, then by default theÂ hostnameÂ command inside that Pod returnsÂ busybox-1Â and theÂ hostname â€“fqdnÂ the command returns the FQDN.

When you setÂ `setHostnameAsFQDN: true`Â in the Pod spec, the kubelet writes the Podâ€™s FQDN into the hostname for that Podâ€™s namespace. In this case, bothÂ `hostname`Â andÂ `hostname --fqdn`Â return the Podâ€™s FQDN.

##### ğŸ“„&#xA;Â Note

In Linux, the hostname field of the kernel (theÂ nodenameÂ field ofÂ struct utsname) is limited to 64 characters.

If a Pod enables this feature and its FQDN is longer than 64 character, it will fail to start. The Pod will remain inÂ `Pending`Â status (`ContainerCreating`Â as seen byÂ `kubectl`) generating error events, such as Failed to construct FQDN from Pod hostname and cluster domain, FQDNÂ `long-FQDN`Â is too long (64 characters is the max, 70 characters requested). One way of improving user experience for this scenario is to create anÂ [admission webhook controller](https://kubernetes.io/docs/reference/access-authn-authz/extensible-admission-controllers/#what-are-admission-webhooks)Â to control FQDN size when users create top level objects, for example, Deployment.

### Podâ€™s DNS Policy

DNS policies can be set on a per-Pod basis. Currently Kubernetes supports the following Pod-specific DNS policies. These policies are specified in theÂ `dnsPolicy`Â field of a Pod Spec.

* â€œ`Default`â€œ: The Pod inherits the name resolution configuration from the node that the Pods run on. SeeÂ [related discussion](https://kubernetes.io/docs/tasks/administer-cluster/dns-custom-nameservers)Â for more details.

* â€œ`ClusterFirst`â€œ: Any DNS query that does not match the configured cluster domain suffix, such as â€œ`www.kubernetes.io`â€œ, is forwarded to an upstream nameserver by the DNS server. Cluster administrators may have extra stub-domain and upstream DNS servers configured. SeeÂ [related discussion](https://kubernetes.io/docs/tasks/administer-cluster/dns-custom-nameservers)Â for details on how DNS queries are handled in those cases.

* â€œ`ClusterFirstWithHostNet`â€œ: For Pods running with hostNetwork, you should explicitly set its DNS policy to â€œ`ClusterFirstWithHostNet`â€œ. Otherwise, Pods running with hostNetwork andÂ `"ClusterFirst"`Â will fallback to the behavior of theÂ `"Default"`Â policy.

  * Note: This is not supported on Windows. SeeÂ [below](https://kubernetes.io/docs/concepts/services-networking/dns-pod-service/#dns-windows)Â for details

* â€œ`None`â€œ: It allows a Pod to ignore DNS settings from the Kubernetes environment. All DNS settings are supposed to be provided using theÂ `dnsConfig`Â field in the Pod Spec. SeeÂ [Podâ€™s DNS config](https://kubernetes.io/docs/concepts/services-networking/dns-pod-service/#pod-dns-config)Â subsection below.

**Note:**Â â€œDefaultâ€ is not the default DNS policy. IfÂ `dnsPolicy`Â is not explicitly specified, then â€œClusterFirstâ€ is used.

The example below shows a Pod with its DNS policy set to â€œ`ClusterFirstWithHostNet`â€ because it hasÂ `hostNetwork`Â set toÂ `true`.

`apiVersion: v1`
`kind: Pod`
`metadata:`
`  name: busybox`
`  namespace: default`
`spec:`
`  containers:`
`  - image: busybox:1.28`
`    command:`
`      - sleep`
`      - "3600"`
`    imagePullPolicy: IfNotPresent`
`    name: busybox`
`  restartPolicy: Always`
`  hostNetwork: true`
`  dnsPolicy: ClusterFirstWithHostNet`

### Podâ€™s DNS Config

**FEATURE STATE:**Â `Kubernetes v1.14 [stable]`

Podâ€™s DNS Config allows users more control on the DNS settings for a Pod.

TheÂ `dnsConfig`Â field is optional and it can work with anyÂ `dnsPolicy`Â settings. However, when a Podâ€™sÂ `dnsPolicy`Â is set to â€œ`None`â€œ, theÂ `dnsConfig`Â field has to be specified.

Below are the properties a user can specify in theÂ `dnsConfig`Â field:

* `nameservers`: a list of IP addresses that will be used as DNS servers for the Pod. There can be at most 3 IP addresses specified. When the Podâ€™sÂ `dnsPolicy`Â is set to â€œ`None`â€œ, the list must contain at least one IP address, otherwise this property is optional. The servers listed will be combined to the base nameservers generated from the specified DNS policy with duplicate addresses removed.

* `searches`: a list of DNS search domains for hostname lookup in the Pod. This property is optional. When specified, the provided list will be merged into the base search domain names generated from the chosen DNS policy. Duplicate domain names are removed. Kubernetes allows up to 32 search domains.

* `options`: an optional list of objects where each object may have aÂ `name`Â property (required) and aÂ `value`Â property (optional). The contents in this property will be merged to the options generated from the specified DNS policy. Duplicate entries are removed.

The following is an example Pod with custom DNS settings:

[`service/networking/custom-dns.yaml`Â ](https://raw.githubusercontent.com/kubernetes/website/main/content/en/examples/service/networking/custom-dns.yaml)![](data:image/gif;base64,R0lGODlhAQABAAAAACH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==)

`apiVersion: v1`
`kind: Pod`
`metadata:`
`  namespace: default`
`  name: dns-example`
`spec:`
`  containers:`
`    - name: test`
`      image: nginx`
`  dnsPolicy: "None"`
`  dnsConfig:`
`    nameservers:`
`      - 192.0.2.1 # this is an example`
`    searches:`
`      - ns1.svc.cluster-domain.example`
`      - my.dns.search.suffix`
`    options:`
`      - name: ndots`
`        value: "2"`
`      - name: edns0`

When the Pod above is created, the containerÂ `test`Â gets the following contents in itsÂ `/etc/resolv.conf`Â file:

`nameserver 192.0.2.1`
`search ns1.svc.cluster-domain.example my.dns.search.suffix`
`options ndots:2 edns0`

For IPv6 setup, the search path and name server should be set up like this:

`kubectl exec -it dns-example -- cat /etc/resolv.conf`


The output is similar to this:

`nameserver 2001:db8:30::a`
`search default.svc.cluster-domain.example svc.cluster-domain.example cluster-domain.example`
`options ndots:5`

## DNS search domain list limits

**FEATURE STATE:**Â `Kubernetes 1.28 [stable]`

Kubernetes itself does not limit the DNS Config until the length of the search domain list exceeds 32 or the total length of all search domains exceeds 2048. This limit applies to the nodeâ€™s resolver configuration file, the Podâ€™s DNS Config, and the merged DNS Config respectively.

**Note:**

Some container runtimes of earlier versions may have their own restrictions on the number of DNS search domains. Depending on the container runtime environment, the pods with a large number of DNS search domains may get stuck in the pending state.

It is known that containerd v1.5.5 or earlier and CRI-O v1.21 or earlier have this problem.

## DNS resolution on Windows nodes

* ClusterFirstWithHostNet is not supported for Pods that run on Windows nodes. Windows treats all names with aÂ `.`Â as a FQDN and skips FQDN resolution.

* On Windows, there are multiple DNS resolvers that can be used. As these come with slightly different behaviors, using theÂ [`Resolve-DNSName`](https://docs.microsoft.com/powershell/module/dnsclient/resolve-dnsname)Â powershell cmdlet for name query resolutions is recommended.

* On Linux, you have a DNS suffix list, which is used after resolution of a name as fully qualified has failed. On Windows, you can only have 1 DNS suffix, which is the DNS suffix associated with that Podâ€™s namespace (example:Â `mydns.svc.cluster.local`). Windows can resolve FQDNs, Services, or network name which can be resolved with this single suffix. For example, a Pod spawned in theÂ `default`Â namespace, will have the DNS suffixÂ `default.svc.cluster.local`. Inside a Windows Pod, you can resolve bothÂ `kubernetes.default.svc.cluster.local`Â andÂ `kubernetes`, but not the partially qualified names (`kubernetes.default`Â orÂ `kubernetes.default.svc`).